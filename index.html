<!DOCTYPE html>
<html lang="pt-BR">
<head>
Â  <meta charset="utf-8" />
Â  <title>KaraokÃª do Japa â€” Playlist</title>
Â  <meta name="viewport" content="width=device-width,initial-scale=1" />
Â  <style>
Â  Â  html, body { margin:0; padding:0; color:#fff; font-family: Arial, sans-serif; background: url('./9937771.jpg') no-repeat center center fixed; background-size: cover; height:100vh; }
Â  Â  .container { display:flex; flex-direction:column; min-height:100vh; }
Â  Â  header { text-align:center; padding:10px 0; }
Â  Â  header img { max-width:480px; width:90%; height:auto; }
Â  Â  main.wrap { display:flex; gap:30px; padding:10px; justify-content:center; align-items:flex-start; flex:1; }

Â  Â  .left { width:260px; background:rgba(0,0,0,0.5); border-radius:12px; padding:18px; }
Â  Â  .right { flex:1; background:rgba(0,0,0,0.7); border-radius:12px; padding:20px; text-align:center; min-height:380px; max-width:900px; }

Â  Â  input#codigo { width:200px; padding:12px; font-size:20px; border-radius:8px; border:none; text-align:center; }
Â  Â  .keypad { display:grid; grid-template-columns:repeat(3,80px); gap:10px; margin-top:15px; justify-content:center; }
Â  Â  .keypad button { padding:12px; font-size:18px; border-radius:8px; border:none; cursor:pointer; background:#333; color:#fff; }
Â  Â  .keypad .enter { background:#28a745; grid-column:1 / -1; font-size:20px; padding:14px; }
Â  Â  .keypad .back { background:#ff8800; }
Â  Â  .keypad .clear { background:#dc3545; }

Â  Â  .thumbnails { display:flex; flex-wrap:wrap; justify-content:center; gap:20px; margin-top:20px; }
Â  Â  .thumbnails img { width:240px; border-radius:10px; border:3px solid #666; cursor:pointer; transition: transform .15s; }
Â  Â  .thumbnails img:hover { transform:scale(1.08); border-color:#ffcc00; }

Â  Â  /* Fila */
Â  Â  #filaContainer { margin-top:18px; background:rgba(255,255,255,0.03); padding:12px; border-radius:10px; text-align:left; }
Â  Â  #filaVideos { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
Â  Â  .fila-item { width:120px; background:rgba(0,0,0,0.6); border-radius:8px; padding:8px; text-align:center; position:relative; cursor:grab; }
Â  Â  .fila-item.dragging { opacity:0.5; }
Â  Â  .fila-item img { width:100%; border-radius:6px; }
Â  Â  .fila-item p { font-size:12px; margin:6px 0 0; }
Â  Â  .fila-item button.remove { position:absolute; top:6px; right:6px; background:#dc3545; border:none; color:white; border-radius:50%; width:26px; height:26px; cursor:pointer; }

Â  Â  #playFila { margin-top:12px; padding:10px 16px; font-size:18px; border-radius:8px; border:none; background:#007bff; color:white; cursor:pointer; }
Â  Â  #playFila:disabled { opacity:0.4; cursor:not-allowed; }

Â  Â  /* Webviewer */
Â  Â  #webviewer { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); display:none; justify-content:center; align-items:center; z-index:9999; flex-direction:column; }
Â  Â  #youtubeFrame { width:100%; height:100vh; }
Â  Â  #closeBtn { position:absolute; top:15px; right:20px; background:#dc3545; color:white; border:none; font-size:22px; border-radius:50%; width:45px; height:45px; cursor:pointer; z-index:10000; }

Â  Â  #score-display { position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); display:none; flex-direction:column; justify-content:center; align-items:center; z-index:99999; text-align:center; }
Â  Â  #score-text { font-size:15vw; font-weight:bold; color:#ffcc00; text-shadow:0 0 20px #ff0000; }
Â  Â  #score-label { font-size:4vw; color:#fff; margin-top:20px; }
Â  Â  #countdown { font-size:5vw; margin-top:10px; color:#fff; }

Â  Â  .fireworks { position:absolute; width:100%; height:100%; pointer-events:none; z-index:100000; display:none; }
Â  Â  .firework { position:absolute; width:10px; height:10px; border-radius:50%; opacity:0; animation:explode 1s ease-out forwards; }
Â  Â  @keyframes explode { 0%{transform:scale(0);opacity:1;} 100%{transform:scale(40);opacity:0;} }

Â  Â  @media (max-width:768px) { main.wrap { flex-direction:column; align-items:center; gap:20px; } .left{ width:100%; max-width:300px;} .right{ width:95%; min-height:200px; order:-1;} .thumbnails img{ width:100%; max-width:180px;} .fila-item{ width:84px; } #score-text{ font-size:20vw;} }
Â  </style>
</head>
<body>
Â  <header><img src="./logo.png" alt="KaraokÃª do Japa" /></header>
Â  <div class="container">
Â  Â  <main class="wrap">
Â  Â  Â  <section class="left">
Â  Â  Â  Â  <p>Digite o cÃ³digo da mÃºsica:</p>
Â  Â  Â  Â  <input id="codigo" placeholder="Ex: 6197" type="tel" inputmode="none" />
Â  Â  Â  Â  <div class="keypad">
Â  Â  Â  Â  Â  <button onclick="digitar('1')">1</button>
Â  Â  Â  Â  Â  <button onclick="digitar('2')">2</button>
Â  Â  Â  Â  Â  <button onclick="digitar('3')">3</button>
Â  Â  Â  Â  Â  <button onclick="digitar('4')">4</button>
Â  Â  Â  Â  Â  <button onclick="digitar('5')">5</button>
Â  Â  Â  Â  Â  <button onclick="digitar('6')">6</button>
Â  Â  Â  Â  Â  <button onclick="digitar('7')">7</button>
Â  Â  Â  Â  Â  <button onclick="digitar('8')">8</button>
Â  Â  Â  Â  Â  <button onclick="digitar('9')">9</button>
Â  Â  Â  Â  Â  <button class="back" onclick="backspace()">BACK</button>
Â  Â  Â  Â  Â  <button onclick="digitar('0')">0</button>
Â  Â  Â  Â  Â  <button class="clear" onclick="clearAll()">C</button>
Â  Â  Â  Â  Â  <button class="enter" onclick="buscar()">âœ” ENTER</button>
Â  Â  Â  Â  </div>

        Â  Â  Â  </section>

Â  Â  Â  <section class="right" id="resultado">
Â  Â  Â  Â  <p>ğŸ” Digite um cÃ³digo para comeÃ§ar.</p>

        <div id="filaContainer">
Â  Â  Â  Â  Â  <h3>ğŸ¶ Fila de mÃºsicas <small id="filaCount">(0/5)</small></h3>
Â  Â  Â  Â  Â  <div id="filaVideos"> </div>
Â  Â  Â  Â  Â  <button id="playFila" onclick="iniciarFila()" disabled>â–¶ï¸ Iniciar Playlist</button>
Â  Â  Â  Â  </div>
        Â  Â  Â  </section>
Â  Â  </main>
Â  </div>

Â  <div id="webviewer">
Â  Â  <button id="closeBtn" onclick="fecharWebViewer()">âœ•</button>
Â  Â  <div id="youtubeFrame"></div>

Â  Â  <div id="score-display">
Â  Â  Â  <div id="fireworks-container" class="fireworks">
Â  Â  Â  Â  <div class="firework" style="left:20%;top:80%;background:#f00"></div>
Â  Â  Â  Â  <div class="firework" style="left:50%;top:50%;background:#0f0;animation-delay:0.5s"></div>
Â  Â  Â  Â  <div class="firework" style="left:80%;top:70%;background:#00f;animation-delay:1s"></div>
Â  Â  Â  Â  <div class="firework" style="left:35%;top:60%;background:#ff0;animation-delay:1.5s"></div>
Â  Â  Â  Â  <div class="firework" style="left:65%;top:90%;background:#f0f;animation-delay:2s"></div>
Â  Â  Â  </div>
Â  Â  Â  <div id="score-label">SUA NOTA:</div>
Â  Â  Â  <div id="score-text">0</div>
Â  Â  Â  <div id="countdown"></div>
Â  Â  </div>
Â  </div>

Â  <audio id="bgAudio" src="./ambiente.mp3" loop></audio>
Â  <audio id="applauseAudio" src="./aplausos.mp3" preload="auto"></audio>
Â  <audio id="dingAudio" src="./ding.mp3" preload="auto"></audio>

Â  <script>
Â  Â  // --- Assets & UI refs
Â  Â  const bgAudio = document.getElementById('bgAudio'); bgAudio.volume = 0.15;
Â  Â  const applauseAudio = document.getElementById('applauseAudio'); applauseAudio.volume = 0.8;
Â  Â  const dingAudio = document.getElementById('dingAudio'); dingAudio.volume = 0.9;
Â  Â  const scoreDisplay = document.getElementById('score-display');
Â  Â  const scoreText = document.getElementById('score-text');
Â  Â  const fireworksContainer = document.getElementById('fireworks-container');
Â  Â  const countdownEl = document.getElementById('countdown');
Â  Â  const codigo = document.getElementById('codigo');
Â  Â  const resultado = document.getElementById('resultado');
Â  Â  const filaVideos = document.getElementById('filaVideos');
Â  Â  const filaCount = document.getElementById('filaCount');
Â  Â  const playFilaBtn = document.getElementById('playFila');
Â  Â  const viewer = document.getElementById('webviewer');

Â  Â  // --- Data & constants
Â  Â  let musicas = [];
Â  Â  const API_KEY = "AIzaSyABdd6X4cKzMHR8JVWdw0jlLoFY4UDRQ88"; // permanece no cliente (melhor usar backend)
Â  Â  const MAX_FILA = 5;

Â  Â  // Fila de reproduÃ§Ã£o
Â  Â  let fila = []; // { videoId, title, thumb, artista, musica }
Â  Â  let currentIndex = 0;
Â  Â  let ytPlayer = null;

Â  Â  document.addEventListener('click', () => { if (bgAudio.paused) bgAudio.play().catch(()=>{}); }, { once:true });

Â  Â  async function carregarMusicas(){ try{ const res = await fetch('./karaoke.json'); musicas = await res.json(); }catch(e){ console.error('Erro ao carregar karaoke.json', e);} }

Â  Â  function atualizarFilaUI(){ filaVideos.innerHTML = '';
Â  Â  Â  fila.forEach((it, idx) => {
Â  Â  Â  Â  const div = document.createElement('div'); div.className = 'fila-item'; div.setAttribute('draggable','true'); div.dataset.index = idx;
Â  Â  Â  Â  div.innerHTML = `
Â  Â  Â  Â  Â  <button class="remove" title="Remover" onclick="removerDaFila(${idx})">âœ•</button>
Â  Â  Â  Â  Â  <img src="${it.thumb}" alt="${escapeHtml(it.title)}">
Â  Â  Â  Â  Â  <p title="${escapeHtml(it.title)}">${escapeHtml(truncate(it.title,28))}</p>
Â  Â  Â  Â  `;
Â  Â  Â  Â  // drag events
Â  Â  Â  Â  div.addEventListener('dragstart', dragStart);
Â  Â  Â  Â  div.addEventListener('dragend', dragEnd);
Â  Â  Â  Â  div.addEventListener('dragover', dragOver);
Â  Â  Â  Â  div.addEventListener('drop', dragDrop);
Â  Â  Â  Â  filaVideos.appendChild(div);
Â  Â  Â  });
Â  Â  Â  filaCount.textContent = `(${fila.length}/${MAX_FILA})`;
Â  Â  Â  playFilaBtn.disabled = fila.length === 0;
Â  Â  }

Â  Â  function escapeHtml(text){ return String(text).replace(/[&<>"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]; }); }
Â  Â  function truncate(s,n){ return s.length>n? s.slice(0,n-1)+'â€¦': s; }

Â  Â  function adicionarNaFila(item){ if(fila.length>=MAX_FILA){ alert('Fila cheia (mÃ¡x 5). Remova algum item antes de adicionar.'); return; }
Â  Â  Â  fila.push(item); atualizarFilaUI(); }

Â  Â  function removerDaFila(idx){ fila.splice(idx,1); atualizarFilaUI(); }

Â  Â  // Drag & Drop handlers (simples)
Â  Â  let dragSrcIndex = null;
Â  Â  function dragStart(e){ this.classList.add('dragging'); dragSrcIndex = Number(this.dataset.index); e.dataTransfer.effectAllowed = 'move'; }
Â  Â  function dragEnd(){ this.classList.remove('dragging'); dragSrcIndex = null; atualizarFilaUI(); }
Â  Â  function dragOver(e){ e.preventDefault(); e.dataTransfer.dropEffect = 'move'; }
Â  Â  function dragDrop(e){ e.preventDefault(); const destIndex = Number(this.dataset.index); if(dragSrcIndex===null||isNaN(destIndex)) return; const [moved] = fila.splice(dragSrcIndex,1); fila.splice(destIndex,0,moved); atualizarFilaUI(); }

Â  Â  // Keyboard helpers
Â  Â  function digitar(n){ codigo.value += n; }
Â  Â  function backspace(){ codigo.value = codigo.value.slice(0,-1); }
Â  Â  function clearAll(){ codigo.value = ''; }

Â  Â  // Busca youtube
Â  Â  async function buscar(){ const codigoVal = codigo.value.trim(); resultado.innerHTML = ''; codigo.blur(); const item = musicas.find(m => Number(m.codigo) === Number(codigoVal));
Â  Â  Â  if(!item){ resultado.innerHTML = '<p>âŒ CÃ³digo nÃ£o encontrado.</p>'; 
Â  Â  Â  Â  document.getElementById('filaContainer').style.display='block'; return; } // Garante que a fila Ã© exibida
Â  Â  Â  resultado.innerHTML = `<h2>${escapeHtml(item.artista)} - ${escapeHtml(item.musica)}</h2><div class='thumbnails'></div>`;
Â  Â  Â  // Reposiciona a filaContainer apÃ³s o resultado, para evitar que desapareÃ§a.
Â  Â  Â  const filaDiv = document.getElementById('filaContainer');
Â  Â  Â  if(filaDiv) resultado.appendChild(filaDiv); 
Â  Â  Â  
Â  Â  Â  const thumbs = resultado.querySelector('.thumbnails');
Â  Â  Â  const query = `karaoke ${item.artista} ${item.musica}`;
Â  Â  Â  const url = `https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&maxResults=6&q=${encodeURIComponent(query)}&key=${API_KEY}`;
Â  Â  Â  try{
Â  Â  Â  Â  const res = await fetch(url);
Â  Â  Â  Â  const data = await res.json();
Â  Â  Â  Â  const videos = (data.items||[]).filter(i=>i.id?.videoId);
Â  Â  Â  Â  if(!videos.length){ resultado.innerHTML += '<p>âŒ Nenhum vÃ­deo encontrado.</p>'; return; }
Â  Â  Â  Â  videos.slice(0,3).forEach(v=>{
Â  Â  Â  Â  Â  const img = document.createElement('img'); img.src = v.snippet.thumbnails.medium.url; img.alt = v.snippet.title;
Â  Â  Â  Â  Â  img.title = 'Adicionar Ã  fila';
Â  Â  Â  Â  Â  img.style.cursor = 'pointer';
Â  Â  Â  Â  Â  img.onclick = () => {
Â  Â  Â  Â  Â  Â  adicionarNaFila({ videoId: v.id.videoId, title: v.snippet.title, thumb: v.snippet.thumbnails.default.url || v.snippet.thumbnails.medium.url, artista: item.artista, musica: item.musica });
Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  thumbs.appendChild(img);
Â  Â  Â  Â  });
Â  Â  Â  }catch(err){ resultado.innerHTML = '<p>âŒ Erro ao buscar vÃ­deo.</p>'; console.error(err); }
Â  Â  }

Â  Â  // Player & workflow
Â  Â  function abrirWebViewer(){ viewer.style.display = 'flex'; scoreDisplay.style.display = 'none'; fireworksContainer.style.display = 'none'; if(!document.getElementById('ytapi')){ const tag = document.createElement('script'); tag.id='ytapi'; tag.src='https://www.youtube.com/iframe_api'; document.body.appendChild(tag); }
Â  Â  Â  if(window.YT && YT.Player){ /* noop - will init when creating player */ } else { window.onYouTubeIframeAPIReady = ()=>{}; }
Â  Â  }

Â  Â  function criarPlayerECarregar(videoId){ // sempre recria para garantir eventos limpos
Â  Â  Â  const frameContainer = document.getElementById('youtubeFrame'); frameContainer.innerHTML = '';
Â  Â  Â  if(ytPlayer){ try{ ytPlayer.destroy(); }catch(e){} ytPlayer = null; }
Â  Â  Â  ytPlayer = new YT.Player('youtubeFrame', {
Â  Â  Â  Â  videoId: videoId,
Â  Â  Â  Â  playerVars: { autoplay:1, controls:1, rel:0, modestbranding:1 },
Â  Â  Â  Â  events: {
Â  Â  Â  Â  Â  'onReady': (e)=>{ const iframe = e.target.getIframe(); iframe.style.width='100%'; iframe.style.height='100vh'; },
Â  Â  Â  Â  Â  'onStateChange': (e)=>{ if(e.data === YT.PlayerState.ENDED) onVideoEnded(); }
Â  Â  Â  Â  }
Â  Â  Â  });
Â  Â  }

Â  Â  // SequÃªncia de reproduÃ§Ã£o
Â  Â  async function iniciarFila(){ 
      if(!fila.length) return; 
      
      // NOVA MODIFICAÃ‡ÃƒO: PAUSA O ÃUDIO AMBIENTE
      try { bgAudio.pause(); bgAudio.currentTime = 0; } catch(e) {}
      
      currentIndex = 0; 
      abrirWebViewer(); 
      playCurrent(); 
    }
Â  Â  function playCurrent(){ const it = fila[currentIndex]; if(!it) return; // load YT API then player
Â  Â  Â  if(window.YT && YT.Player){ criarPlayerECarregar(it.videoId); } else { window.onYouTubeIframeAPIReady = ()=> criarPlayerECarregar(it.videoId); const tag = document.getElementById('ytapi'); if(!tag){ const s = document.createElement('script'); s.id='ytapi'; s.src='https://www.youtube.com/iframe_api'; document.body.appendChild(s); } }
Â  Â  }

Â  Â  // Quando vÃ­deo termina
Â  Â  let scoreInterval = null; let countdownInterval = null;
Â  Â  function onVideoEnded(){ mostrarPontuacao(() => { // callback apÃ³s pontuaÃ§Ã£o e contagem
Â  Â  Â  Â  // se houver prÃ³ximo vÃ­deo
Â  Â  Â  Â  if(currentIndex < fila.length - 1){ currentIndex++; playCurrent(); } else { // fim da fila
Â  Â  Â  Â  Â  // fecha apÃ³s a contagem final
Â  Â  Â  Â  Â  setTimeout(()=>{ fecharWebViewer(true); }, 500); // slight delay
Â  Â  Â  Â  }
Â  Â  Â  }); }

Â  Â  function mostrarPontuacao(cb){ try{ if(ytPlayer && ytPlayer.stopVideo) ytPlayer.stopVideo(); }catch(e){}
Â  Â  Â  scoreDisplay.style.display = 'flex'; scoreText.textContent = '0'; applauseAudio.currentTime = 0; applauseAudio.play().catch(()=>{});
Â  Â  Â  // anima nÃºmeros aleatÃ³rios por 2s
Â  Â  Â  let localInt = setInterval(()=>{ scoreText.textContent = Math.floor(Math.random()*101); }, 60);
Â  Â  Â  setTimeout(()=>{
Â  Â  Â  Â  clearInterval(localInt);
Â  Â  Â  Â  const finalScore = Math.floor(Math.random()*(100-75+1))+75;
Â  Â  Â  Â  scoreText.textContent = finalScore;
Â  Â  Â  Â  fireworksContainer.style.display = 'block';
Â  Â  Â  Â  // aguarda 2s e entÃ£o inicia contagem regressiva de 10s
Â  Â  Â  Â  setTimeout(()=>{ iniciarContagemRegressiva(10, cb); }, 2000);
Â  Â  Â  }, 2000);
Â  Â  }

Â  Â  function iniciarContagemRegressiva(segundos, cb){ let s = segundos; countdownEl.textContent = `PrÃ³xima mÃºsica em ${s}...`;
Â  Â  Â  // toca ding no inÃ­cio
Â  Â  Â  try{ dingAudio.currentTime = 0; dingAudio.play().catch(()=>{}); }catch(e){}
Â  Â  Â  countdownInterval = setInterval(()=>{
Â  Â  Â  Â  s--; if(s>=0) countdownEl.textContent = `PrÃ³xima mÃºsica em ${s}...`; if(s<=0){ clearInterval(countdownInterval); countdownEl.textContent = ''; scoreDisplay.style.display = 'none'; fireworksContainer.style.display = 'none'; try{ applauseAudio.pause(); applauseAudio.currentTime = 0; }catch(e){} if(cb) cb(); }
Â  Â  Â  }, 1000);
Â  Â  }

    // MODIFICAÃ‡ÃƒO: FECHAR WEBVIEWER REVISADO PARA RETOMAR ÃUDIO AMBIENTE
Â  Â  function fecharWebViewer(skipReset=false){ 
      viewer.style.display = 'none'; 
      scoreDisplay.style.display = 'none'; 
      fireworksContainer.style.display = 'none'; 
      countdownEl.textContent = ''; 
      try{ applauseAudio.pause(); applauseAudio.currentTime = 0; dingAudio.pause(); dingAudio.currentTime = 0; }catch(e){}

Â  Â  Â  if(ytPlayer){ try{ ytPlayer.destroy(); }catch(e){} ytPlayer = null; }
Â  Â  Â  codigo.value = '';

Â  Â  Â  if(!skipReset){ // Se nÃ£o foi final da fila (fechamento manual)
Â  Â  Â  Â  // Retoma o Ã¡udio ambiente e mantÃ©m a fila
Â  Â  Â  Â  bgAudio.play().catch(()=>{});
Â  Â  Â  } else { // Se foi final da fila (chamado com true)
Â  Â  Â  Â  // Retoma o Ã¡udio ambiente e limpa a fila
Â  Â  Â  Â  fila = []; 
Â  Â  Â  Â  atualizarFilaUI(); 
Â  Â  Â  Â  resultado.innerHTML = '<p>ğŸ” Digite um cÃ³digo para comeÃ§ar.</p>'; 
        // Garante que o div da fila volte para a seÃ§Ã£o 'resultado' com o p de 'comeÃ§ar'
        const filaDiv = document.getElementById('filaContainer');
        if(filaDiv) resultado.appendChild(filaDiv); 
Â  Â  Â  Â  bgAudio.play().catch(()=>{});
      }
    }

Â  Â  // init
Â  Â  carregarMusicas(); atualizarFilaUI();

Â  Â  // expose some functions to inline handlers
Â  Â  window.digitar = digitar; window.backspace = backspace; window.clearAll = clearAll; window.buscar = buscar; window.adicionarNaFila = adicionarNaFila; window.removerDaFila = removerDaFila; window.iniciarFila = iniciarFila; window.fecharWebViewer = fecharWebViewer;
Â  </script>
</body>
</html>
