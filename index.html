<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<title>Karaok√™ do Japa ‚Äî Playlist</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  html, body { margin:0; padding:0; color:#fff; font-family: Arial, sans-serif;
    background: url('./9937771.jpg') no-repeat center center fixed; background-size: cover; height:100vh; }
  .container { display:flex; flex-direction:column; min-height:100vh; }
  header { text-align:center; padding:10px 0; }
  header img { max-width:480px; width:90%; height:auto; }
  main.wrap { display:flex; gap:30px; padding:10px; justify-content:center; align-items:flex-start; flex:1; }
  .left { width:260px; background:rgba(0,0,0,0.5); border-radius:12px; padding:18px; }
  .right { flex:1; background:rgba(0,0,0,0.7); border-radius:12px; padding:20px; text-align:center; min-height:380px; max-width:900px; }
  input#codigo { width:200px; padding:12px; font-size:20px; border-radius:8px; border:none; text-align:center; }
  .keypad { display:grid; grid-template-columns:repeat(3,80px); gap:10px; margin-top:15px; justify-content:center; }
  .keypad button { padding:12px; font-size:18px; border-radius:8px; border:none; cursor:pointer; background:#333; color:#fff; }
  .keypad .enter { background:#28a745; grid-column:1 / -1; font-size:20px; padding:14px; }
  .keypad .back { background:#ff8800; }
  .keypad .clear { background:#dc3545; }

  /* Miniaturas e fila direita */
  .thumbnails { display:flex; flex-wrap:wrap; justify-content:center; gap:16px; margin-top:20px; }
  .thumbnails img { width:160px; border-radius:10px; border:3px solid #666; cursor:pointer; transition: transform .15s; }
  .thumbnails img:hover { transform:scale(1.08); border-color:#ffcc00; }

  #filaContainer { margin-top:20px; background: rgba(255,255,255,0.05); padding:14px; border-radius:10px; text-align:center; }
  #filaVideos { display:flex; gap:6px; justify-content:center; flex-wrap:wrap; margin-top:10px; }
  .fila-item { width:90px; background: rgba(0,0,0,0.6); border-radius:8px; padding:6px; text-align:center; position:relative; cursor:grab; }
  .fila-item.dragging { opacity:0.5; }
  .fila-item img { width:100%; border-radius:6px; }
  .fila-item p { font-size:10px; margin:4px 0 0; }
  .fila-item button.remove { position:absolute; top:4px; right:4px; background:#dc3545; border:none; color:white; border-radius:50%; width:22px; height:22px; cursor:pointer; }
  #playFila { margin-top:12px; padding:10px 16px; font-size:16px; border-radius:8px; border:none; background:#007bff; color:white; cursor:pointer; }
  #playFila:disabled { opacity:0.4; cursor:not-allowed; }

  #webviewer { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); display:none; justify-content:center; align-items:center; z-index:9999; flex-direction:column; }
  #youtubeFrame { width:100%; height:100vh; }
  #closeBtn { position:absolute; top:15px; right:20px; background:#dc3545; color:white; border:none; font-size:22px; border-radius:50%; width:45px; height:45px; cursor:pointer; z-index:10000; }

  #score-display { position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); display:none; flex-direction:column; justify-content:center; align-items:center; z-index:99999; text-align:center; }
  #score-text { font-size:15vw; font-weight:bold; color:#ffcc00; text-shadow:0 0 20px #ff0000; }
  #score-label { font-size:4vw; color:#fff; margin-top:20px; }
  #countdown { font-size:5vw; margin-top:10px; color:#fff; }

  .fireworks { position:absolute; width:100%; height:100%; pointer-events:none; z-index:100000; display:none; }
  .firework { position:absolute; width:10px; height:10px; border-radius:50%; opacity:0; animation:explode 1s ease-out forwards; }
  @keyframes explode { 0%{transform:scale(0);opacity:1;} 100%{transform:scale(40);opacity:0;} }

  @media (max-width:768px) {
    main.wrap { flex-direction:column; align-items:center; gap:20px; }
    .left{ width:100%; max-width:300px; }
    .right{ width:95%; min-height:200px; order:-1; }
    .thumbnails img{ width:100%; max-width:160px; }
    .fila-item{ width:70px; }
    .fila-item p{ font-size:9px; }
    #score-text{ font-size:20vw; }
  }
</style>
</head>
<body>
<header><img src="./logo.png" alt="Karaok√™ do Japa" /></header>
<div class="container">
  <main class="wrap">
    <section class="left">
      <p>Digite o c√≥digo da m√∫sica:</p>
      <input id="codigo" placeholder="Ex: 6197" type="tel" inputmode="none" />
      <div class="keypad">
        <button onclick="digitar('1')">1</button>
        <button onclick="digitar('2')">2</button>
        <button onclick="digitar('3')">3</button>
        <button onclick="digitar('4')">4</button>
        <button onclick="digitar('5')">5</button>
        <button onclick="digitar('6')">6</button>
        <button onclick="digitar('7')">7</button>
        <button onclick="digitar('8')">8</button>
        <button onclick="digitar('9')">9</button>
        <button class="back" onclick="backspace()">BACK</button>
        <button onclick="digitar('0')">0</button>
        <button class="clear" onclick="clearAll()">C</button>
        <button class="enter" onclick="buscar()">‚úî ENTER</button>
      </div>
    </section>

    <section class="right" id="resultado">
      <p>üîé Digite um c√≥digo para come√ßar.</p>
      <div class="thumbnails"></div>

      <div id="filaContainer">
        <h3>üé∂ Fila de m√∫sicas <small id="filaCount">(0/5)</small></h3>
        <div id="filaVideos"></div>
        <button id="playFila" onclick="iniciarFila()" disabled>‚ñ∂Ô∏è Iniciar Playlist</button>
      </div>
    </section>
  </main>
</div>

<div id="webviewer">
  <button id="closeBtn" onclick="fecharWebViewer()">‚úï</button>
  <div id="youtubeFrame"></div>
  <div id="score-display">
    <div id="fireworks-container" class="fireworks">
      <div class="firework" style="left:20%;top:80%;background:#f00"></div>
      <div class="firework" style="left:50%;top:50%;background:#0f0;animation-delay:0.5s"></div>
      <div class="firework" style="left:80%;top:70%;background:#00f;animation-delay:1s"></div>
      <div class="firework" style="left:35%;top:60%;background:#ff0;animation-delay:1.5s"></div>
      <div class="firework" style="left:65%;top:90%;background:#f0f;animation-delay:2s"></div>
    </div>
    <div id="score-label">SUA NOTA:</div>
    <div id="score-text">0</div>
    <div id="countdown"></div>
  </div>
</div>

<audio id="bgAudio" src="./ambiente.mp3" loop></audio>
<audio id="applauseAudio" src="./aplausos.mp3" preload="auto"></audio>
<audio id="dingAudio" src="./ding.mp3" preload="auto"></audio>

<script>
const bgAudio = document.getElementById('bgAudio'); bgAudio.volume=0.15;
const applauseAudio = document.getElementById('applauseAudio'); applauseAudio.volume=0.8;
const dingAudio = document.getElementById('dingAudio'); dingAudio.volume=0.9;
const scoreDisplay = document.getElementById('score-display');
const scoreText = document.getElementById('score-text');
const fireworksContainer = document.getElementById('fireworks-container');
const countdownEl = document.getElementById('countdown');
const codigo = document.getElementById('codigo');
const resultado = document.getElementById('resultado');
const filaVideos = document.getElementById('filaVideos');
const filaCount = document.getElementById('filaCount');
const playFilaBtn = document.getElementById('playFila');
const viewer = document.getElementById('webviewer');

let musicas=[]; const API_KEY="AIzaSyABdd6X4cKzMHR8JVWdw0jlLoFY4UDRQ88";
const MAX_FILA=5; let fila=[]; let currentIndex=0; let ytPlayer=null;

document.addEventListener('click',()=>{ if(bgAudio.paused) bgAudio.play().catch(()=>{}); }, {once:true});

async function carregarMusicas(){ try{ const res=await fetch('./karaoke.json'); musicas=await res.json(); }catch(e){console.error(e);} }

function escapeHtml(text){ return String(text).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
function truncate(s,n){ return s.length>n?s.slice(0,n-1)+'‚Ä¶':s; }

function atualizarFilaUI(){ filaVideos.innerHTML='';
  fila.forEach((it,idx)=>{
    const div=document.createElement('div'); div.className='fila-item'; div.setAttribute('draggable','true'); div.dataset.index=idx;
    div.innerHTML=`<button class="remove" title="Remover" onclick="removerDaFila(${idx})">‚úï</button><img src="${it.thumb}" alt="${escapeHtml(it.title)}"><p title="${escapeHtml(it.title)}">${escapeHtml(truncate(it.title,28))}</p>`;
    div.addEventListener('dragstart',dragStart);
    div.addEventListener('dragend',dragEnd);
    div.addEventListener('dragover',dragOver);
    div.addEventListener('drop',dragDrop);
    filaVideos.appendChild(div);
  });
  filaCount.textContent=`(${fila.length}/${MAX_FILA})`;
  playFilaBtn.disabled=fila.length===0;
}

function adicionarNaFila(item){ if(fila.length>=MAX_FILA){ alert('Fila cheia (m√°x 5)'); return; } fila.push(item); atualizarFilaUI(); }
function removerDaFila(idx){ fila.splice(idx,1); atualizarFilaUI(); }

let dragSrcIndex=null;
function dragStart(e){ this.classList.add('dragging'); dragSrcIndex=Number(this.dataset.index); e.dataTransfer.effectAllowed='move'; }
function dragEnd(){ this.classList.remove('dragging'); dragSrcIndex=null; atualizarFilaUI(); }
function dragOver(e){ e.preventDefault(); e.dataTransfer.dropEffect='move'; }
function dragDrop(e){ e.preventDefault(); const destIndex=Number(this.dataset.index); if(dragSrcIndex===null||isNaN(destIndex)) return; const [moved]=fila.splice(dragSrcIndex,1); fila.splice(destIndex,0,moved); atualizarFilaUI(); }

function digitar(n){ codigo.value+=n; }
function backspace(){ codigo.value=codigo.value.slice(0,-1); }
function clearAll(){ codigo.value=''; }

async function buscar(){
  const codigoVal=codigo.value.trim(); resultado.querySelector('.thumbnails').innerHTML=''; codigo.blur();
  const item=musicas.find(m=>Number(m.codigo)===Number(codigoVal));
  if(!item){ resultado.innerHTML='<p>‚ùå C√≥digo n√£o encontrado.</p>'; return; }
  resultado.innerHTML=`<h2>${escapeHtml(item.artista)} - ${escapeHtml(item.musica)}</h2><div class='thumbnails'></div>`;
  const thumbs=resultado.querySelector('.thumbnails');
  const query=`karaoke ${item.artista} ${item.musica}`;
  const url=`https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&maxResults=6&q=${encodeURIComponent(query)}&key=${API_KEY}`;
  try{
    const res=await fetch(url); const data=await res.json(); const videos=(data.items||[]).filter(i=>i.id?.videoId);
    if(!videos.length){ resultado.innerHTML+='<p>‚ùå Nenhum v√≠deo encontrado.</p>'; return; }
    videos.slice(0,3).forEach(v=>{
      const img=document.createElement('img'); img.src=v.snippet.thumbnails.medium.url; img.alt=v.snippet.title;
      img.title='Adicionar √† fila'; img.style.cursor='pointer';
      img.onclick=()=>{ adicionarNaFila({ videoId:v.id.videoId, title:v.snippet.title, thumb:v.snippet.thumbnails.default.url||v.snippet.thumbnails.medium.url, artista:item.artista, musica:item.musica }); };
      thumbs.appendChild(img);
    });
  }catch(err){ resultado.innerHTML+='<p>‚ùå Erro ao buscar v√≠deo.</p>'; console.error(err); }
}

function abrirWebViewer(){ viewer.style.display='flex'; scoreDisplay.style.display='none'; fireworksContainer.style.display='none'; }

function criarPlayerECarregar(videoId){
  const frameContainer=document.getElementById('youtubeFrame'); frameContainer.innerHTML='';
  if(ytPlayer){ try{ ytPlayer.destroy(); }catch(e){} ytPlayer=null; }
  ytPlayer=new YT.Player('youtubeFrame',{ videoId:videoId, playerVars:{autoplay:1,controls:1,rel:0,modestbranding:1}, events:{
    'onReady':e=>{ const iframe=e.target.getIframe(); iframe.style.width='100%'; iframe.style.height='100vh'; },
    'onStateChange':e=>{ if(e.data===YT.PlayerState.ENDED) onVideoEnded(); }
  }});
}

function iniciarFila(){ if(!fila.length) return; bgAudio.pause(); currentIndex=0; abrirWebViewer(); playCurrent(); }
function playCurrent(){ const it=fila[currentIndex]; if(!it) return; if(window.YT && YT.Player){ criarPlayerECarregar(it.videoId); } else { window.onYouTubeIframeAPIReady=()=>criarPlayerECarregar(it.videoId); if(!document.getElementById('ytapi')){ const s=document.createElement('script'); s.id='ytapi'; s.src='https://www.youtube.com/iframe_api'; document.body.appendChild(s); } } }

function onVideoEnded(){ mostrarPontuacao(()=>{ if(currentIndex<fila.length-1){ currentIndex++; playCurrent(); } else { setTimeout(()=>{ fecharWebViewer(true); bgAudio.play().catch(()=>{}); },500); } }); }

function mostrarPontuacao(cb){
  if(ytPlayer && ytPlayer.stopVideo) ytPlayer.stopVideo();
  scoreDisplay.style.display='flex'; fireworksContainer.style.display='none'; scoreText.textContent='0'; applauseAudio.currentTime=0; applauseAudio.play().catch(()=>{});
  let localInt=setInterval(()=>{ scoreText.textContent=Math.floor(Math.random()*101); },60);
  setTimeout(()=>{
    clearInterval(localInt);
    const finalScore=Math.floor(Math.random()*(100-75+1))+75; scoreText.textContent=finalScore; fireworksContainer.style.display='block';
    setTimeout(()=>{ iniciarContagemRegressiva(10,cb); },2000);
  },2000);
}

function iniciarContagemRegressiva(segundos,cb){ let s=segundos; countdownEl.textContent=`Pr√≥xima m√∫sica em ${s}...`; dingAudio.currentTime=0; dingAudio.play().catch(()=>{}); 
let interval=setInterval(()=>{ s--; if(s>=0) countdownEl.textContent=`Pr√≥xima m√∫sica em ${s}...`; if(s<=0){ clearInterval(interval); countdownEl.textContent=''; scoreDisplay.style.display='none'; fireworksContainer.style.display='none'; applauseAudio.pause(); applauseAudio.currentTime=0; if(cb) cb(); } },1000);
}

function fecharWebViewer(force=false){ viewer.style.display='none'; scoreDisplay.style.display='none'; fireworksContainer.style.display='none'; countdownEl.textContent=''; if(ytPlayer){ try{ ytPlayer.destroy(); }catch(e){} ytPlayer=null; } applauseAudio.pause(); applauseAudio.currentTime=0; dingAudio.pause(); dingAudio.currentTime=0; if(force){ fila=[]; atualizarFilaUI(); resultado.innerHTML='<p>üîé Digite um c√≥digo para come√ßar.</p>'; } }

carregarMusicas(); atualizarFilaUI();
window.digitar=digitar; window.backspace=backspace; window.clearAll=clearAll; window.buscar=buscar; window.adicionarNaFila=adicionarNaFila; window.removerDaFila=removerDaFila; window.iniciarFila=iniciarFila; window.fecharWebViewer=fecharWebViewer;
</script>
</body>
</html>
